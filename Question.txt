<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>帳號檢核</title>
    <link rel="stylesheet" href="./02-jQuery.css" />
  </head>
  <body>
    <h1>帳號產生程式</h1>
    <section id="pink">
      <!-- elevenAccount (11碼) -->
      <div class="elevenNum">
        <label for="startAccount">起始帳號：</label>
        <input type="text" id="startAccount" name="startAccount" required />
      </div>

      <!-- amount (數量) -->
      <div class="amount">
        <label for="accountCount">帳號數：</label>
        <input
          type="number"
          id="accountCount"
          name="accountCount"
          min="1"
          max="9999"
          required
        />
      </div>

      <button class="btn" type="submit">產生帳號</button>
    </section>

    <!-- <h3>產生帳號如下:</h3> -->
    <div id="result"></div>

    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.js"
      integrity="sha512-+k1pnlgt4F1H8L7t3z95o3/KO+o78INEcXTbnoJQ/F2VqDVhWoaiVml/OEHv9HsVgxUaVW+IbiZPUJQfF/YxZw=="
      crossorigin="anonymous"
    ></script>

    <script>
      $(document).ready(function () {
        // Focus 起始帳號的輸入框
        $("#startAccount").focus();

        let produceID = function () {
          // 起始帳號
          let startId = $("#startAccount").val(); // string
          let startNum = parseInt(startId);

          // 分行別
          let bankCode = startId.substring(0, 3);
          // console.log(typeof bankCode);

          // 科目
          let subject = startId.substring(3, 5);

          // 帳號數
          let amountId = parseInt($("#accountCount").val());

          // 前 11 碼
          let elevenNum = startId.substring(0, 11);

          // 11碼中，最後6個數字
          let lastSixNum = startId.substring(5, 11);

          // 符合輸入的檢核，才能做事
          // 計算公式: 00240|809876|0  00150|123456|9  來測試
          function calc(input) {
            let validSubject = ["30", "40", "66"];
            let zeroNum = "00000";
            let multiplyNum = [5, 4, 3, 2, 8, 7, 6, 5, 4, 3, 2];

            // 計算 Y
            if (
              (subject === "20" || (bankCode >= "001" && bankCode <= "007")) &&
              validSubject.includes(subject)
            ) {
              input = zeroNum + lastSixNum; // string '00000809876'

              let y = 0;
              for (let i = 0; i < 11; i++) {
                y += parseInt(input[i]) * multiplyNum[i];
              }
              let x = y % 11;
              let z = x === 0 ? 1 : x === 1 ? 0 : 11 - x; // z 目前為 number

              // startId 得到 12 碼
              input += z.toString();
              return input; //  string '002408098760'
            } else {
              let y = 0;
              for (let i = 0; i < 11; i++) {
                y += parseInt(input[i]) * multiplyNum[i];
              }
              let x = y % 11;
              let z = x === 0 ? 1 : x === 1 ? 0 : 11 - x; // z 目前為 number

              input += z.toString();
              return input; // string '001501234569'
            }
          }

          // 生成帳號
          let resultID = "";
          for (let i = 0; i < amountId; i++) {
            let checkId = calc(startId); // string

            resultID += checkId + "<br/>";
          }

          // 原本的 生成帳號
          // let resultID = "";
          // for (let i = 0; i < amountId; i++) {
          //   let AC = parseInt(startId) + i;
          //   let checkId = calc(AC);
          //   resultID += AC + checkId +"<br/>";
          // }

          if (!/^\d+$/.test(startId)) {
            alert("起始帳號需為數字");
          } else if (amountId > 9999 || amountId < 1) {
            alert("帳號數錯誤");
          } else if (
            !(bankCode >= "001" && bankCode <= "099") ||
            bankCode === "019"
          ) {
            alert("分行別錯誤");
          } else if (
            !["10", "20", "30", "40", "50", "51", "66", "77", "88"].includes(
              subject
            )
          ) {
            alert("科目別錯誤");
          } else {
            $("#result").html(resultID);
          }
        };

        // else if (startId.length != 11) {
        //     alert("起始帳號長度錯誤");
        //   }

        // 按下按鈕 click
        $(".btn").click(function () {
          produceID();
        });

        // 按下 Enter
        $("body").keypress(function (e) {
          if (e.which === 13) {
            produceID();
          }
        });
      });
    </script>
  </body>
</html>
